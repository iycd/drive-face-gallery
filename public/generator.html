<!DOCTYPE html>
<html>
<head>
    <title>AI Indexer System</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-950 text-white font-sans p-8">
    <div class="max-w-2xl mx-auto bg-slate-900 border border-slate-800 p-8 rounded-[2.5rem] shadow-2xl">
        <div class="flex items-center gap-4 mb-8">
            <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
                <i class="fa-solid fa-microchip text-xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-black uppercase tracking-tighter italic">Biometric Indexer</h1>
                <p class="text-slate-500 text-[10px] font-bold tracking-widest uppercase">Admin Control Panel</p>
            </div>
        </div>

        <div class="space-y-6">
            <div class="grid gap-4">
                <input id="scriptUrl" type="text" class="w-full bg-slate-800 border border-slate-700 p-4 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="URL Web App Google Script">
                <input id="folderId" type="text" class="w-full bg-slate-800 border border-slate-700 p-4 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="ID Folder Drive (Subfolder akan ikut discan)">
            </div>

            <div id="statusBox" class="hidden bg-black/40 p-6 rounded-3xl border border-indigo-500/20 animate-in zoom-in-95">
                <div class="flex justify-between items-end mb-3">
                    <span id="statusText" class="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Inisialisasi...</span>
                    <span id="percentText" class="text-2xl font-black italic">0%</span>
                </div>
                <div class="w-full bg-slate-800 h-2.5 rounded-full overflow-hidden shadow-inner">
                    <div id="progressBar" class="bg-indigo-500 h-full w-0 transition-all duration-300 shadow-[0_0_15px_rgba(99,102,241,0.5)]"></div>
                </div>
                <p id="logText" class="text-[9px] font-mono text-slate-500 mt-3 truncate opacity-60 italic"></p>
            </div>

            <button id="syncBtn" class="w-full bg-indigo-600 hover:bg-indigo-500 p-5 rounded-[1.5rem] font-black text-sm uppercase tracking-[0.2em] shadow-xl shadow-indigo-500/10 transition-all active:scale-95">
                SINKRONISASI DATABASE AI
            </button>
        </div>
    </div>

    <script>
        let isSyncing = false;

        async function initAI() {
            const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models";
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
        }

        document.getElementById('syncBtn').onclick = async () => {
            if(isSyncing) return;
            const url = document.getElementById('scriptUrl').value;
            const fid = document.getElementById('folderId').value;
            if(!url || !fid) return alert("Isi data terlebih dahulu!");

            isSyncing = true;
            document.getElementById('statusBox').classList.remove('hidden');
            document.getElementById('syncBtn').innerText = "PROSES SCANNING...";
            document.getElementById('syncBtn').classList.add('opacity-50');

            try {
                await initAI();
                document.getElementById('statusText').innerText = "Membaca Folder & Subfolder...";
                const res = await fetch(`${url}?folderId=${fid}`);
                const data = await res.json();
                const files = data.files || [];

                const faceDB = [];
                for(let i=0; i < files.length; i++) {
                    const f = files[i];
                    document.getElementById('logText').innerText = `Proses: ${f.name}`;
                    try {
                        const imgUrl = `https://wsrv.nl/?url=${encodeURIComponent(f.full)}&w=600&output=jpg`;
                        const img = await faceapi.fetchImage(imgUrl);
                        const dets = await faceapi.detectAllFaces(img, new faceapi.TinyFaceDetectorOptions({ inputSize: 416 }))
                                              .withFaceLandmarks().withFaceDescriptors();
                        if(dets.length > 0) {
                            faceDB.push({ fileId: f.id, faces: dets.map(d => Array.from(d.descriptor)) });
                        }
                    } catch(e) { console.warn("Skip file", f.name); }
                    
                    const p = Math.round(((i+1)/files.length)*100);
                    document.getElementById('progressBar').style.width = p + '%';
                    document.getElementById('percentText').innerText = p + '%';
                }

                document.getElementById('statusText').innerText = "Menyimpan ke Cloud...";
                await fetch(url, { method: 'POST', body: JSON.stringify({ action: "saveDB", data: faceDB }) });
                
                alert("DATABASE BERHASIL DISINKRONISASI!");
            } catch(e) { alert("Error: " + e.message); }
            
            isSyncing = false;
            document.getElementById('syncBtn').innerText = "SINKRONISASI DATABASE AI";
            document.getElementById('syncBtn').classList.remove('opacity-50');
        };
    </script>
</body>
</html>
